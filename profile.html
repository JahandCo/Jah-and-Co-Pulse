<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | Community Pulse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../assets/style.css">
    <script src="https://unpkg.com/heroicons@2.0.13/24/outline.js"></script>
</head>
<body>
    <canvas id="particle-canvas"></canvas>

    <div id="main-app-view" style="display: none;" class="fade-in-section">
        <header class="app-header container mx-auto flex justify-between items-center sticky top-0 bg-opacity-80 backdrop-blur-md z-10 border-b border-purple-900/50">
            <a href="../" class="header-logo text-2xl font-bold uppercase tracking-widest text-white">
                <img src="../assets/images/sparky-headshot.png" alt="Sparky Mascot">
                <span>Jah and Co <span class="text-main-purple pulse-animated">Pulse</span></span>
            </a>
            <nav class="flex items-center gap-8">
                <a href="../" class="nav-link"><i class="hero-outline-home"></i>Timeline</a>
                <a href="../groups/" class="nav-link"><i class="hero-outline-users"></i>Groups</a>
                <a href="../board/" class="nav-link"><i class="hero-outline-chat-bubble-left-right"></i>Board</a>
                <a href="./" class="nav-link active"><i class="hero-outline-user-circle"></i>Profile</a>
                <button id="logout-button" class="neon-button !py-2 !px-6 !text-sm"><i class="hero-outline-arrow-left-on-rectangle"></i>Logout</button>
            </nav>
        </header>

        <main class="main-content container mx-auto py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
                <aside class="lg:col-span-1 space-y-10">
                    <section class="card">
                        <h2 class="text-2xl font-bold mb-4">My Profile</h2>
                        <div id="display-name-suggestion" class="hidden bg-yellow-900/50 border border-yellow-400 text-yellow-300 px-4 py-3 rounded-lg mb-4 text-sm">
                            <p><strong class="font-bold">Suggestion:</strong> Add a display name to make it easier for others to recognize you!</p>
                        </div>
                        <form id="update-profile-form" class="space-y-4">
                            <input type="text" id="update-displayname" placeholder="Your Display Name" class="input-field w-full" required>
                            <button type="submit" class="neon-button w-full">Save Name</button>
                            <p id="update-success" class="text-green-400 h-4 text-sm"></p>
                        </form>
                    </section>

                    <section id="theme-switcher" class="card">
                        <h2 class="text-2xl font-bold mb-4">Theme Options</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <button data-theme="default" class="theme-button neon-button w-full">Default</button>
                            <button data-theme="navy" class="theme-button neon-button w-full">Navy</button>
                            <button data-theme="purple" class="theme-button neon-button w-full">Purple</button>
                            <button data-theme="pink" class="theme-button neon-button w-full">Pink</button>
                            <button data-theme="gray" class="theme-button neon-button w-full">Gray</button>
                            <button data-theme="white" class="theme-button neon-button w-full">White</button>
                        </div>
                    </section>

                    <section class="card">
                        <h2 class="text-2xl font-bold mb-4">My Friends</h2>
                        <p class="text-gray-400">Friend system coming soon!</p>
                    </section>
                </aside>

                <div class="lg:col-span-2">
                    <h2 class="text-4xl font-bold mb-8 text-white">My Posts</h2>
                    <div id="my-posts-container" class="space-y-8"></div>
                </div>
            </div>
        </main>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, where, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { setTheme, loadTheme } from '../assets/theme.js';

        loadTheme();
        
        const firebaseConfig = {
  apiKey: "AIzaSyAVVrmwHH8E6Gc613aO4WfCJuGP9DdpLOM",
  authDomain: "jah-and-co-dev.firebaseapp.com",
  projectId: "jah-and-co-dev",
  storageBucket: "jah-and-co-dev.firebasestorage.app",
  messagingSenderId: "451434139963",
  appId: "1:451434139963:web:b4bfbffc472678c4c3671e",
  measurementId: "G-N6L3JN4604"
};
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const mainAppView = document.getElementById('main-app-view');
        const logoutButton = document.getElementById('logout-button');
        const updateProfileForm = document.getElementById('update-profile-form');
        const displayNameInput = document.getElementById('update-displayname');
        const myPostsContainer = document.getElementById('my-posts-container');
        const themeSwitcher = document.getElementById('theme-switcher');
        const displayNameSuggestion = document.getElementById('display-name-suggestion');

        themeSwitcher.addEventListener('click', (e) => {
            if (e.target.classList.contains('theme-button')) {
                const themeName = e.target.dataset.theme;
                setTheme(themeName);
            }
        });
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                mainAppView.style.display = 'block';
                displayNameInput.value = user.displayName || '';
                if (!user.displayName) {
                    displayNameSuggestion.classList.remove('hidden');
                }
                listenForMyPosts(user.uid);
            } else {
                window.location.href = '../login/';
            }
        });

        logoutButton.addEventListener('click', () => signOut(auth));

        updateProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newDisplayName = displayNameInput.value.trim();
            const user = auth.currentUser;
            if (!newDisplayName || !user) return;
            try {
                // Update the user's profile in Firebase Authentication
                await updateProfile(user, { displayName: newDisplayName });

                // **THE FIX:** Use setDoc with merge:true to create or update the user document in Firestore
                const userDocRef = doc(db, "users", user.uid);
                await setDoc(userDocRef, { displayName: newDisplayName }, { merge: true });
                
                const successMsg = document.getElementById('update-success');
                successMsg.textContent = "Display name updated!";
                displayNameSuggestion.classList.add('hidden');
                setTimeout(() => successMsg.textContent = '', 3000);
            } catch (error) {
                console.error("Error updating profile: ", error);
                alert("Could not update display name.");
            }
        });

        function listenForMyPosts(userId) {
            const postsQuery = query(collection(db, "posts"), where("authorId", "==", userId), orderBy("createdAt", "desc"));
            onSnapshot(postsQuery, (snapshot) => {
                myPostsContainer.innerHTML = '';
                if (snapshot.empty) {
                    myPostsContainer.innerHTML = `<div class="card text-center"><p class="text-xl text-gray-400">You haven't posted anything yet.</p></div>`;
                    return;
                }
                snapshot.forEach((docSnapshot) => {
                    const post = docSnapshot.data();
                    const postElement = document.createElement('article');
                    postElement.className = 'card fade-in-section';
                    postElement.setAttribute('data-id', docSnapshot.id);
                    const date = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleString() : 'Just now';
                    const author = post.authorDisplayName || post.authorId;
                    postElement.innerHTML = `
                        <header class="flex items-center gap-4 mb-4">
                            <i class="hero-outline-user-circle text-main-purple text-5xl"></i>
                            <div>
                                <h3 class="font-bold text-xl">${author}</h3>
                                <span class="text-sm text-gray-400">${date}</span>
                            </div>
                             <button class="delete-post-button secondary-button !text-red-500 hover:!text-red-400 ml-auto"><i class="hero-outline-trash"></i></button>
                        </header>
                        <div class="text-gray-200 text-lg whitespace-pre-wrap leading-relaxed">${post.content}</div>
                    `;
                    myPostsContainer.appendChild(postElement);
                });
            });
        }

        myPostsContainer.addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('.delete-post-button');
            if(deleteButton) {
                const postElement = e.target.closest('.card');
                const postId = postElement.dataset.id;
                if(confirm("Are you sure you want to delete this post?")) {
                    await deleteDoc(doc(db, "posts", postId));
                }
            }
        });
    </script>
    <script>
        // --- PARTICLE ANIMATION SCRIPT ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        
        function resizeCanvas() { 
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 4 + 1;
                this.speedX = (Math.random() - 0.5) * 1.5;
                this.speedY = (Math.random() - 0.5) * 1.5;
                if (window.particleColors) {
                    this.color = window.particleColors[Math.floor(Math.random() * window.particleColors.length)];
                } else {
                    this.color = "#FFFFFF";
                }
                this.opacity = Math.random() * 0.5 + 0.2;
            }
            update() {
                this.x += this.speedX; this.y += this.speedY;
                if (this.x < 0 || this.x > canvas.width) this.x = Math.random() * canvas.width;
                if (this.y < 0 || this.y > canvas.height) this.y = Math.random() * canvas.height;
            }
            draw() {
                ctx.globalAlpha = this.opacity; ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
            }
        }

        window.initParticles = function() {
            particles = [];
            let n = (canvas.width * canvas.height) / 8000;
            for (let i = 0; i < n; i++) { particles.push(new Particle()); }
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', () => { resizeCanvas(); window.initParticles(); });
        resizeCanvas();
        animate();
    </script>
</body>
</html>
