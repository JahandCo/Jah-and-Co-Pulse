<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="My Profile - Community Pulse">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    
    <title>My Profile | Community Pulse</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/css/style.css">
    
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body>
    <canvas id="particle-canvas"></canvas>

    <div id="main-app-view" class="fade-in-section">
        <header class="app-header container mx-auto flex justify-between items-center sticky top-0 bg-opacity-80 backdrop-blur-md z-10 border-b border-purple-900/50">
            <a href="index.html" id="header-logo-link" class="header-logo text-2xl font-bold uppercase tracking-widest text-white">
                <img src="assets/images/sparky-headshot.png" alt="Sparky Mascot" onerror="this.style.display='none'">
                <span>Jah and Co <span class="text-main-purple pulse-animated">Pulse</span></span>
            </a>
            <nav class="flex items-center gap-8">
                <a href="index.html" class="nav-link"><i class="ph ph-house"></i>Timeline</a>
                <a href="groups.html" class="nav-link"><i class="ph ph-users"></i>Groups</a>
                <a href="board.html" class="nav-link"><i class="ph ph-chats"></i>Board</a>
                <a href="chat.html" class="nav-link"><i class="ph ph-chat-circle-dots"></i>Chat</a>
                <a href="profile.html" class="nav-link active"><i class="ph ph-user-circle"></i>Profile</a>
                <button id="logout-button" class="neon-button !py-2 !px-6 !text-sm"><i class="ph ph-sign-out"></i>Logout</button>
            </nav>
        </header>

        <main class="main-content container mx-auto py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
                <aside class="lg:col-span-1 space-y-10">
                    <section class="card">
                        <h2 class="text-2xl font-bold mb-4">My Profile</h2>
                        <div id="display-name-suggestion" class="hidden bg-yellow-900/50 border border-yellow-400 text-yellow-300 px-4 py-3 rounded-lg mb-4 text-sm">
                            <p><strong class="font-bold">Suggestion:</strong> Add a display name to make it easier for others to recognize you!</p>
                        </div>
                        <form id="update-profile-form" class="space-y-4">
                            <input type="text" id="update-displayname" placeholder="Your Display Name" class="input-field w-full" required>
                            <button type="submit" class="neon-button w-full">Save Name</button>
                            <p id="update-success" class="text-green-400 h-4 text-sm"></p>
                        </form>
                    </section>

                    <section id="theme-switcher" class="card">
                        <h2 class="text-2xl font-bold mb-4">Theme Options</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <button data-theme="default" class="theme-button neon-button w-full">Default</button>
                            <button data-theme="navy" class="theme-button neon-button w-full">Navy</button>
                            <button data-theme="purple" class="theme-button neon-button w-full">Purple</button>
                            <button data-theme="pink" class="theme-button neon-button w-full">Pink</button>
                            <button data-theme="gray" class="theme-button neon-button w-full">Gray</button>
                            <button data-theme="white" class="theme-button neon-button w-full">White</button>
                        </div>
                    </section>

                    <section class="card">
                        <h2 class="text-2xl font-bold mb-4">My Friends</h2>
                        <p class="text-gray-400">Friend system coming soon!</p>
                    </section>
                </aside>

                <div class="lg:col-span-2">
                    <h2 class="text-4xl font-bold mb-8 text-white">My Posts</h2>
                    <div id="my-posts-container" class="space-y-8"></div>
                </div>
            </div>
        </main>
    </div>
    
    <script type="module">
        import { app } from "./assets/js/firebase-config.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, where, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { setTheme, loadTheme } from './assets/js/theme.js';
        import { isAdmin } from './assets/js/utils.js';

        loadTheme();
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const mainAppView = document.getElementById('main-app-view');
        const logoutButton = document.getElementById('logout-button');
        const updateProfileForm = document.getElementById('update-profile-form');
        const displayNameInput = document.getElementById('update-displayname');
        const myPostsContainer = document.getElementById('my-posts-container');
        const themeSwitcher = document.getElementById('theme-switcher');
        const displayNameSuggestion = document.getElementById('display-name-suggestion');

        themeSwitcher.addEventListener('click', (e) => {
            if (e.target.classList.contains('theme-button')) {
                const themeName = e.target.dataset.theme;
                setTheme(themeName);
            }
        });
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                updateHeaderForAdmin(user);
                mainAppView.style.display = 'block';
                displayNameInput.value = user.displayName || '';
                if (!user.displayName) {
                    displayNameSuggestion.classList.remove('hidden');
                }
                listenForMyPosts(user.uid);
            } else {
                window.location.href = 'login.html';
            }
        });

        logoutButton.addEventListener('click', () => signOut(auth));

        updateProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newDisplayName = displayNameInput.value.trim();
            const user = auth.currentUser;
            if (!newDisplayName || !user) return;
            try {
                // Update the user's profile in Firebase Authentication
                await updateProfile(user, { displayName: newDisplayName });

                // **THE FIX:** Use setDoc with merge:true to create or update the user document in Firestore
                const userDocRef = doc(db, "users", user.uid);
                await setDoc(userDocRef, { displayName: newDisplayName }, { merge: true });
                
                const successMsg = document.getElementById('update-success');
                successMsg.textContent = "Display name updated!";
                displayNameSuggestion.classList.add('hidden');
                setTimeout(() => successMsg.textContent = '', 3000);
            } catch (error) {
                console.error("Error updating profile: ", error);
                alert("Could not update display name.");
            }
        });

        function listenForMyPosts(userId) {
            const postsQuery = query(collection(db, "posts"), where("authorId", "==", userId), orderBy("createdAt", "desc"));
            onSnapshot(postsQuery, (snapshot) => {
                myPostsContainer.innerHTML = '';
                if (snapshot.empty) {
                    myPostsContainer.innerHTML = `<div class="card text-center"><p class="text-xl text-gray-400">You haven't posted anything yet.</p></div>`;
                    return;
                }
                snapshot.forEach((docSnapshot) => {
                    const post = docSnapshot.data();
                    const postElement = document.createElement('article');
                    postElement.className = 'card fade-in-section';
                    postElement.setAttribute('data-id', docSnapshot.id);
                    const date = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleString() : 'Just now';
                    const author = post.authorDisplayName || post.authorId;
                    postElement.innerHTML = `
                        <header class="flex items-center gap-4 mb-4">
                            <i class="ph ph-user-circle text-main-purple text-5xl"></i>
                            <div>
                                <h3 class="font-bold text-xl">${author}</h3>
                                <span class="text-sm text-gray-400">${date}</span>
                            </div>
                             <button class="delete-post-button secondary-button !text-red-500 hover:!text-red-400 ml-auto"><i class="ph ph-trash"></i></button>
                        </header>
                        <div class="text-gray-200 text-lg whitespace-pre-wrap leading-relaxed">${post.content}</div>
                    `;
                    myPostsContainer.appendChild(postElement);
                });
            });
        }

        myPostsContainer.addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('.delete-post-button');
            if(deleteButton) {
                const postElement = e.target.closest('.card');
                const postId = postElement.dataset.id;
                if(confirm("Are you sure you want to delete this post?")) {
                    await deleteDoc(doc(db, "posts", postId));
                }
            }
        });
        function updateHeaderForAdmin(user) {
    if (isAdmin(user)) {
        const headerLink = document.getElementById('header-logo-link');
        if (headerLink) {
            const headerTitleSpan = headerLink.querySelector('span');
            if(headerTitleSpan){
                // Add "Admin" and apply the gold class
                headerTitleSpan.innerHTML = `Jah and Co <span class="text-main-purple pulse-animated">Pulse</span> | Admin`;
                headerTitleSpan.classList.add('text-admin-gold');
            }
        }
    }
}
    </script>
    <script type="module" src="assets/js/particle-animation.js"></script>
</body>
</html>
