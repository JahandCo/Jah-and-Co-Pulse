<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Discussion Board - Community Pulse">
    <title>Board | Community Pulse</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/css/style.css">
    
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body>
    <canvas id="particle-canvas"></canvas>

    <div id="main-app-view" style="display: none;" class="fade-in-section">
        <header class="app-header container mx-auto flex justify-between items-center sticky top-0 bg-opacity-80 backdrop-blur-md z-10 border-b border-purple-900/50">
            <a href="index.html" class="header-logo text-2xl font-bold uppercase tracking-widest text-white">
                <img src="assets/images/sparky-headshot.png" alt="Sparky Mascot" onerror="this.style.display='none'">
                <span>Jah and Co <span class="text-main-purple pulse-animated">Pulse</span></span>
            </a>
            <nav class="flex items-center gap-8">
                <a href="index.html" class="nav-link"><i class="ph ph-house"></i>Timeline</a>
                <a href="groups.html" class="nav-link"><i class="ph ph-users"></i>Groups</a>
                <a href="board.html" class="nav-link active"><i class="ph ph-chats"></i>Board</a>
                <a href="profile.html" class="nav-link"><i class="ph ph-user-circle"></i>Profile</a>
                <button id="logout-button" class="neon-button !py-2 !px-6 !text-sm"><i class="ph ph-sign-out"></i>Logout</button>
            </nav>
        </header>

        <main class="main-content container mx-auto py-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold text-white">Discussion Board</h1>
                <button id="create-post-btn" class="neon-button">Create Post</button>
            </div>
            <div id="board-container" class="space-y-8">
                </div>
        </main>
    </div>

    <div id="create-post-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
        <div class="card w-full max-w-2xl relative">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
            <div class="flex border-b border-purple-800 mb-6">
                <button id="show-discussion-btn" class="flex-1 py-3 font-bold text-lg border-b-4 border-main-purple text-white">Discussion</button>
                <button id="show-poll-btn" class="flex-1 py-3 font-bold text-lg border-b-4 border-transparent text-gray-500">Poll</button>
            </div>

            <form id="discussion-form" class="space-y-4">
                <input type="text" id="discussion-title" placeholder="Discussion Title" class="input-field w-full" required>
                <textarea id="discussion-topic" placeholder="What's on your mind?" rows="5" class="input-field w-full" required></textarea>
                <div class="pt-2">
                     <label for="discussion-attachment" class="block text-sm font-bold text-gray-400 mb-2">Attach Image or MP4 (Optional)</label>
                     <input type="file" id="discussion-attachment" accept="image/*,video/mp4" class="input-field w-full text-sm">
                </div>
                <button type="submit" class="neon-button w-full">Post Discussion</button>
            </form>

            <form id="poll-form" class="hidden space-y-4">
                <input type="text" id="poll-title" placeholder="Poll Question" class="input-field w-full" required>
                <div id="poll-options-container" class="space-y-2">
                    <input type="text" name="poll-option" placeholder="Option 1" class="input-field w-full !text-base" required>
                    <input type="text" name="poll-option" placeholder="Option 2" class="input-field w-full !text-base" required>
                </div>
                <button type="button" id="add-option-btn" class="secondary-button text-sm">Add Option</button>
                <div class="pt-2">
                    <label for="poll-duration" class="block text-sm font-bold text-gray-400 mb-2">Poll Duration (in days)</label>
                    <select id="poll-duration" class="input-field w-full !text-base">
                        <option value="1">1 Day</option>
                        <option value="2">2 Days</option>
                        <option value="3" selected>3 Days</option>
                        <option value="4">4 Days</option>
                        <option value="5">5 Days</option>
                    </select>
                </div>
                <button type="submit" class="neon-button w-full">Create Poll</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { app } from "./assets/js/firebase-config.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, getDoc, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        import { loadTheme } from './assets/js/theme.js';

        loadTheme();
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('main-app-view').style.display = 'block';
                listenForBoardPosts();
            } else {
                window.location.href = 'login.html';
            }
        });
        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));

        const modal = document.getElementById('create-post-modal');
        const discussionForm = document.getElementById('discussion-form');
        const pollForm = document.getElementById('poll-form');
        const showDiscussionBtn = document.getElementById('show-discussion-btn');
        const showPollBtn = document.getElementById('show-poll-btn');

        document.getElementById('create-post-btn').addEventListener('click', () => modal.classList.remove('hidden'));
        document.getElementById('close-modal-btn').addEventListener('click', () => modal.classList.add('hidden'));

        showDiscussionBtn.addEventListener('click', () => {
            pollForm.classList.add('hidden');
            discussionForm.classList.remove('hidden');
            showPollBtn.classList.remove('text-white', 'border-main-purple');
            showPollBtn.classList.add('text-gray-500', 'border-transparent');
            showDiscussionBtn.classList.add('text-white', 'border-main-purple');
        });

        showPollBtn.addEventListener('click', () => {
            discussionForm.classList.add('hidden');
            pollForm.classList.remove('hidden');
            showDiscussionBtn.classList.remove('text-white', 'border-main-purple');
            showDiscussionBtn.classList.add('text-gray-500', 'border-transparent');
            showPollBtn.classList.add('text-white', 'border-main-purple');
        });
        
        const boardContainer = document.getElementById('board-container');

        discussionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            const title = document.getElementById('discussion-title').value;
            const topic = document.getElementById('discussion-topic').value;
            const file = document.getElementById('discussion-attachment').files[0];
            let attachmentURL = null;
            let attachmentType = null;

            if (file) {
                const storageRef = ref(storage, `board-attachments/${Date.now()}_${file.name}`);
                await uploadBytes(storageRef, file);
                attachmentURL = await getDownloadURL(storageRef);
                attachmentType = file.type;
            }

            await addDoc(collection(db, "board"), {
                type: 'discussion', title, topic, authorId: user.uid, authorDisplayName: user.displayName,
                createdAt: serverTimestamp(), likes: {}, commentCount: 0, attachmentURL, attachmentType
            });
            modal.classList.add('hidden');
            discussionForm.reset();
        });

        pollForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            const title = document.getElementById('poll-title').value;
            const durationDays = parseInt(document.getElementById('poll-duration').value);
            const endsAt = new Date();
            endsAt.setDate(endsAt.getDate() + durationDays);

            const options = {};
            document.querySelectorAll('input[name="poll-option"]').forEach(opt => {
                if (opt.value.trim()) options[opt.value.trim()] = 0;
            });

            await addDoc(collection(db, "board"), {
                type: 'poll', title, options, authorId: user.uid, authorDisplayName: user.displayName,
                createdAt: serverTimestamp(), endsAt: endsAt, votes: {}, totalVotes: 0, isClosed: false
            });
            modal.classList.add('hidden');
            pollForm.reset();
            document.getElementById('poll-options-container').innerHTML = `
                <input type="text" name="poll-option" placeholder="Option 1" class="input-field w-full !text-base" required>
                <input type="text" name="poll-option" placeholder="Option 2" class="input-field w-full !text-base" required>`;
        });

        document.getElementById('add-option-btn').addEventListener('click', () => {
            const container = document.getElementById('poll-options-container');
            const optionCount = container.children.length + 1;
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.name = 'poll-option';
            newInput.placeholder = `Option ${optionCount}`;
            newInput.className = 'input-field w-full !text-base';
            container.appendChild(newInput);
        });
        
        function listenForBoardPosts() {
            const q = query(collection(db, "board"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                boardContainer.innerHTML = '';
                if(snapshot.empty) {
                     boardContainer.innerHTML = `<div class="card text-center flex flex-col items-center gap-4 empty-state"><img src="assets/images/sparky-headshot.png" alt="Sparky" class="w-24 h-24" onerror="this.style.display='none'"><p class="text-xl text-gray-400">The board is empty. Be the first to start a discussion!</p></div>`;
                }
                snapshot.forEach(doc => {
                    const post = doc.data();
                    const postEl = document.createElement('div');
                    postEl.className = 'card board-post-container';
                    postEl.setAttribute('data-id', doc.id);

                    if (post.type === 'discussion') {
                        renderDiscussion(postEl, post, doc.id);
                    } else if (post.type === 'poll') {
                        renderPoll(postEl, post);
                    }
                    boardContainer.appendChild(postEl);
                });
            });
        }
function renderDiscussion(el, post, postId) {
    const user = auth.currentUser;
    const isOwner = user && user.uid === post.authorId;
    const isAdmin = user && user.displayName === "Jah and Co";
    const deleteBtn = isOwner || isAdmin ? `<button class="delete-post-btn neon-button !bg-red-500 hover:!bg-red-600 !shadow-red-500/50 !py-2 !px-4 !text-sm ml-auto"><i class="ph ph-trash"></i>Delete</button>` : '';
    const adminStar = post.authorDisplayName === "Jah and Co" ? `<img src="assets/images/admin-star.png" class="w-5 h-5 ml-2" title="Official Post" onerror="this.style.display='none'">` : '';
    const likeCount = post.likes ? Object.keys(post.likes).length : 0;
    const isLiked = user && post.likes && post.likes[user.uid];
    const likeButtonClasses = isLiked ? 'text-accent-purple' : 'text-gray-400';

    let attachmentHTML = '';
    if (post.attachmentURL) {
        if (post.attachmentType.startsWith('video')) {
            attachmentHTML = `<video controls src="${post.attachmentURL}" class="max-w-full rounded-lg mt-4"></video>`;
        } else if (post.attachmentType.startsWith('image')) {
            attachmentHTML = `<img src="${post.attachmentURL}" class="max-w-full rounded-lg mt-4">`;
        }
    }

    el.innerHTML = `
        <header class="flex items-start gap-4 mb-4">
            <i class="ph ph-chats text-main-purple text-4xl"></i>
            <div class="flex-grow">
                <h3 class="text-2xl font-bold">${post.title}</h3>
                <div class="flex items-center">
                    <p class="text-sm text-gray-400">Posted by ${post.authorDisplayName || post.authorId}</p>
                    ${adminStar}
                </div>
            </div>
            ${deleteBtn}
        </header>
        <div class="ml-14">
            <p class="text-gray-300">${post.topic}</p>
            ${attachmentHTML}
        </div>
        <footer class="flex items-center gap-6 mt-6 pt-4 border-t border-purple-900/50 ml-14">
            <button class="like-button flex items-center gap-2 ${likeButtonClasses} hover:text-accent-purple text-lg transition-colors">
                <i class="ph ph-heart"></i>
                <span class="like-count font-bold">${likeCount}</span>
            </button>
            <button class="comment-button neon-button !py-2 !px-4 !text-sm">
                <i class="ph ph-chat"></i>
                <span>Comment</span>
                <span class="comment-count font-bold ml-1">${post.commentCount || 0}</span>
            </button>
        </footer>
        <div class="comments-section hidden mt-6 pt-4 border-t border-purple-900/50 ml-14">
            <div class="comments-list space-y-4"></div>
            <form class="comment-form flex gap-2 mt-4">
                <input type="text" placeholder="Add a comment..." class="input-field !text-sm w-full" required>
                <button type="submit" class="neon-button !text-sm !py-2 !px-4">Post</button>
            </form>
        </div>
    `;
}
        function renderPoll(el, post) {
            const user = auth.currentUser;
            const now = new Date();
            const endsAt = post.endsAt.toDate();
            const isPollClosed = post.isClosed || now > endsAt;
            const userVote = user ? post.votes[user.uid] : null;
            const canUserSeeResults = isPollClosed || userVote || (user && user.uid === post.authorId);
            const isAdmin = user && user.displayName === "Jah and Co";
            const adminStar = post.authorDisplayName === "Jah and Co" ? `<img src="assets/images/admin-star.png" class="w-5 h-5 ml-2" title="Official Post" onerror="this.style.display='none'">` : '';

            let optionsHtml = '';

            if (canUserSeeResults) {
                for (const option in post.options) {
                    const voteCount = post.options[option];
                    const percentage = post.totalVotes > 0 ? ((voteCount / post.totalVotes) * 100).toFixed(1) : 0;
                    optionsHtml += `
                        <div class="relative h-10 flex items-center justify-between px-4 text-white font-bold rounded-md overflow-hidden bg-purple-900/50">
                            <div class="absolute top-0 left-0 h-full bg-main-purple/50" style="width: ${percentage}%;"></div>
                            <span class="relative">${option}</span>
                            <span class="relative">${percentage}%</span>
                        </div>`;
                }
            } else {
                 for (const option in post.options) {
                    optionsHtml += `
                        <button data-option="${option}" class="poll-option-btn w-full text-left p-3 rounded-md font-bold transition-colors bg-purple-900/50 hover:bg-purple-900/80">${option}</button>
                    `;
                 }
            }

            const endPollBtn = user && user.uid === post.authorId && !isPollClosed ? `<button class="end-poll-btn secondary-button text-sm !text-yellow-400">End Poll Early</button>` : '';
            const deleteBtn = (user && (user.uid === post.authorId || isAdmin)) ? `<button class="delete-post-btn neon-button !bg-red-500 hover:!bg-red-600 !shadow-red-500/50 !py-2 !px-4 !text-sm"><i class="ph ph-trash"></i>Delete</button>` : '';

            el.innerHTML = `
                 <header class="flex items-start gap-4 mb-4">
                    <i class="ph ph-chart-bar text-main-purple text-4xl"></i>
                    <div class="flex-grow">
                        <h3 class="text-2xl font-bold">${post.title}</h3>
                        <div class="flex items-center">
                             <p class="text-sm text-gray-400">Poll by ${post.authorDisplayName || post.authorId} &bull; ${post.totalVotes} votes</p>
                             ${adminStar}
                        </div>
                    </div>
                    <div class="flex items-center gap-4">${endPollBtn}${deleteBtn}</div>
                </header>
                <div class="space-y-3 ml-14">${optionsHtml}</div>
                <p class="text-xs text-gray-500 text-right mt-4">${isPollClosed ? 'Poll Closed' : `Ends ${endsAt.toLocaleString()}`}</p>
            `;
        }
        
boardContainer.addEventListener('click', async (e) => {
    const postEl = e.target.closest('.card');
    if (!postEl) return;
    const postId = postEl.dataset.id;
    const user = auth.currentUser;

    const optionBtn = e.target.closest('.poll-option-btn');
    if (optionBtn) {
        const docRef = doc(db, "board", postId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists() && docSnap.data().votes[user.uid]) {
            alert("You have already voted in this poll.");
            return;
        }

        const option = optionBtn.dataset.option;
        const voteUpdate = {};
        voteUpdate[`votes.${user.uid}`] = option;
        voteUpdate[`options.${option}`] = increment(1);
        voteUpdate.totalVotes = increment(1);
        await updateDoc(docRef, voteUpdate);
    }
            
            const endPollBtn = e.target.closest('.end-poll-btn');
            if (endPollBtn) {
                if (confirm('Are you sure you want to end this poll early?')) {
                    await updateDoc(doc(db, "board", postId), { isClosed: true });
                }
            }
            
            const deleteBtn = e.target.closest('.delete-post-btn');
            if(deleteBtn) {
                 if (confirm('Are you sure you want to delete this post?')) {
                    await deleteDoc(doc(db, "board", postId));
                }
            }
                const likeButton = e.target.closest('.like-button');
    if (likeButton) {
        if (!user) return;
        const postRef = doc(db, "board", postId);
        const postSnap = await getDoc(postRef);
        if (postSnap.exists()) {
            const postData = postSnap.data();
            const likes = postData.likes || {};
            if (likes[user.uid]) {
                delete likes[user.uid];
            } else {
                likes[user.uid] = true;
            }
            await updateDoc(postRef, { likes });
        }
    }
     const commentButton = e.target.closest('.comment-button');
    if (commentButton) {
        const commentsSection = postEl.querySelector('.comments-section');
        const isHidden = commentsSection.classList.toggle('hidden');
        if (!isHidden) {
            loadComments(postId, postEl.querySelector('.comments-list'));
        }
    }
        });
boardContainer.addEventListener('submit', async (e) => {
    if (!e.target.classList.contains('comment-form')) return;
    e.preventDefault();
    const postEl = e.target.closest('.card');
    const postId = postEl.dataset.id;
    const user = auth.currentUser;
    const input = e.target.querySelector('input');
    const content = input.value.trim();
    if (!content || !user) return;

    try {
        await addDoc(collection(db, "board", postId, "comments"), {
            authorId: user.uid,
            authorDisplayName: user.displayName,
            content: content,
            createdAt: serverTimestamp()
        });
        await updateDoc(doc(db, "board", postId), { commentCount: increment(1) });
        input.value = '';
    } catch (error) { console.error("Error adding comment:", error); }
});

function loadComments(postId, container) {
    const commentsQuery = query(collection(db, "board", postId, "comments"), orderBy("createdAt", "asc"));
    onSnapshot(commentsQuery, (snapshot) => {
        container.innerHTML = '';
        if (snapshot.empty) {
            container.innerHTML = `<p class="text-sm text-gray-500">No comments yet.</p>`;
            return;
        }
        snapshot.forEach(doc => {
            const comment = doc.data();
            const date = comment.createdAt ? new Date(comment.createdAt.toDate()).toLocaleTimeString() : '';
            const commentEl = document.createElement('div');
            commentEl.className = 'flex items-start gap-3';
            const author = comment.authorDisplayName || comment.authorId;
            commentEl.innerHTML = `
                <i class="ph ph-user-circle text-main-purple text-3xl"></i>
                <div class="bg-gray-900/50 p-3 rounded-lg flex-grow">
                    <div class="flex items-baseline gap-2">
                        <span class="font-bold text-sm">${author}</span>
                        <span class="text-xs text-gray-500">${date}</span>
                    </div>
                    <p class="text-gray-300">${comment.content}</p>
                </div>
            `;
            container.appendChild(commentEl);
        });
    });
}
    </script>
    <script type="module" src="assets/js/particle-animation.js"></script>
</body>
</html>