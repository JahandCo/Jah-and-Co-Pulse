<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jah and Co | Community Pulse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="src/css/style.css">
    <script src="https://unpkg.com/hero-icon-js/hero-icon-outline.js"></script>
</head>
<body>
    <canvas id="particle-canvas"></canvas>

    <div id="main-app-view" style="display: none;" class="fade-in-section">
        <header class="app-header container mx-auto flex justify-between items-center sticky top-0 bg-opacity-80 backdrop-blur-md z-10 border-b border-purple-900/50">
            <a href="index.html" class="header-logo text-2xl font-bold uppercase tracking-widest text-white">
                <img src="img/sparky-headshot.png" alt="Sparky Mascot">
                <span>Jah and Co <span class="text-main-purple pulse-animated">Pulse</span></span>
            </a>
            <nav class="flex items-center gap-8">
                <a href="index.html" class="nav-link active"><hero-icon-outline name="home"></hero-icon-outline>Timeline</a>
                <a href="groups.html" class="nav-link"><hero-icon-outline name="users"></hero-icon-outline>Groups</a>
                <a href="board.html" class="nav-link"><hero-icon-outline name="chat-bubble-left-right"></hero-icon-outline>Board</a>
                <a href="profile.html" class="nav-link"><hero-icon-outline name="user-circle"></hero-icon-outline>Profile</a>
                <button id="logout-button" class="neon-button !py-2 !px-6 !text-sm"><hero-icon-outline name="arrow-left-on-rectangle"></hero-icon-outline>Logout</button>
            </nav>
        </header>

        <main class="main-content container mx-auto py-8 flex flex-col lg:flex-row gap-12">
            <aside class="w-full lg:w-1/3 space-y-10 lg:sticky top-28 h-fit">
                <section id="create-post-section" class="card">
                    <form id="create-post-form" class="space-y-4">
                        <h3 class="text-2xl font-bold text-main-purple">Create a Post</h3>
                        <textarea id="post-content-textarea" placeholder="What's on your mind?" rows="4" class="input-field w-full text-lg"></textarea>
                        <div id="post-actions" class="flex justify-between items-center pt-2">
                            <div class="flex items-center gap-4 text-gray-400">
                                <button type="button" title="Attach File (coming soon)" class="hover:text-main-purple transition-colors"><hero-icon-outline name="paper-clip" class="text-2xl"></hero-icon-outline></button>
                                <button type="button" title="Add Link (coming soon)" class="hover:text-main-purple transition-colors"><hero-icon-outline name="link" class="text-2xl"></hero-icon-outline></button>
                            </div>
                            <button type="submit" class="neon-button"><hero-icon-outline name="paper-airplane"></hero-icon-outline>Publish</button>
                        </div>
                    </form>
                </section>
                <section id="jahs-pulse-widget" class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-main-purple">Jah & Co Pulse Board</h3>
                        <a href="https://jahandco.com/pulse" target="_blank" rel="noopener" class="neon-button !py-1 !px-4 !text-xs">View All</a>
                    </div>
                    <div id="pulse-widget-container" class="min-h-[100px]"></div>
                </section>
            </aside>
            <div class="w-full lg:w-2/3">
                <section id="public-timeline-view">
                    <div id="timeline-container" class="space-y-8"></div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { app } from "src/js/firebase-config.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, deleteDoc, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, where, limit, increment } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { loadTheme } from 'dist/js/theme.js';

        loadTheme();
        const db = getFirestore(app);
        const auth = getAuth(app);

        const mainAppView = document.getElementById('main-app-view');
        const logoutButton = document.getElementById('logout-button');
        const createPostForm = document.getElementById('create-post-form');
        const timelineContainer = document.getElementById('timeline-container');
        const pulseWidgetContainer = document.getElementById('pulse-widget-container');
        const postContentTextarea = document.getElementById('post-content-textarea');
        const postActions = document.getElementById('post-actions');



        onAuthStateChanged(auth, (user) => {
            if (user) {
                mainAppView.style.display = 'block';
                postContentTextarea.placeholder = `What's happening, ${user.displayName || 'friend'}?`;
                listenForCommunityPosts();
                loadLatestPulsePost();
            }
            else {
                window.location.href = 'login/';
            }
        });

        logoutButton.addEventListener('click', () => signOut(auth));
        
        createPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = postContentTextarea.value.trim();
            const user = auth.currentUser;
            if (!content || !user) return;
            try {
                await addDoc(collection(db, "posts"), { content, title: null, authorId: user.uid, authorDisplayName: user.displayName, createdAt: serverTimestamp(), likes: {}, commentCount: 0 });
                postContentTextarea.value = '';
            } catch (error) { console.error("Error posting:", error); }
        });

        function loadLatestPulsePost() {
            const pulseQuery = query(collection(db, "posts"), where("authorDisplayName", "==", "Jah and Co"), orderBy("createdAt", "desc"), limit(1));
            onSnapshot(pulseQuery, (snapshot) => {
                pulseWidgetContainer.innerHTML = '';
                if (snapshot.empty) { pulseWidgetContainer.innerHTML = `<p class="text-gray-500">No updates yet.</p>`; return; }
                snapshot.forEach(doc => {
                    const post = doc.data();
                    pulseWidgetContainer.innerHTML = `<h4 class="text-lg font-bold text-main-purple mb-2">${post.title || ''}</h4><p class="text-gray-300 text-sm mb-3">${post.content}</p><p class="text-xs text-gray-500 text-right">${post.date || ''}</p>`;
                });
            });
        }

        function listenForCommunityPosts() {
            const postsQuery = query(collection(db, "posts"), where("title", "==", null), orderBy("createdAt", "desc"));
            onSnapshot(postsQuery, (snapshot) => {
                renderPosts(timelineContainer, snapshot);
            });
        }

        function renderPosts(container, snapshot) {
            const currentUser = auth.currentUser;
            container.innerHTML = '';
            if (snapshot.empty) { 
                container.innerHTML = `
                    <div class="card text-center flex flex-col items-center gap-4 empty-state">
                        <img src="img/sparky-headshot.png" alt="Sparky" class="w-24 h-24">
                        <p class="text-xl text-gray-400">The timeline is quiet...<br>Be the first to post!</p>
                    </div>`;
                return;
            }
            snapshot.forEach((doc, index) => {
                const post = doc.data(), postId = doc.id;
                const postElement = document.createElement('article');
                postElement.className = 'card fade-in-section';
                postElement.style.animationDelay = `${index * 0.1}s`;
                postElement.setAttribute('data-id', postId);

                const date = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleString() : 'Just now';
                const isLiked = currentUser && post.likes && post.likes[currentUser.uid];
                const likeButtonClasses = isLiked ? 'text-accent-purple' : 'text-gray-400';
                const likeCount = post.likes ? Object.keys(post.likes).length : 0;
                const deleteButtonHTML = currentUser && currentUser.uid === post.authorId ? 
                    `<button class="delete-post-button secondary-button !text-red-500 hover:!text-red-600 ml-auto"><hero-icon-outline name="trash"></hero-icon-outline>Delete</button>` : '';
                
                const adminStarHTML = post.authorDisplayName === "Jah and Co" ? 
                    `<img src="img/admin-star.png" class="w-5 h-5 ml-2" title="Official Post">` : '';
                const author = post.authorDisplayName || post.authorId;

                postElement.innerHTML = `
                    <header class="flex items-center gap-4 mb-4">
                        <hero-icon-outline name="user-circle" class="text-main-purple text-5xl"></hero-icon-outline>
                        <div>
                            <div class="flex items-center">
                                <h3 class="font-bold text-xl">${author}</h3>
                                ${adminStarHTML}
                            </div>
                            <span class="text-sm text-gray-400">${date}</span>
                        </div>
                        ${deleteButtonHTML}
                    </header>
                    <div class="text-gray-200 text-lg whitespace-pre-wrap leading-relaxed">${post.content}</div>
                    <footer class="flex items-center gap-6 mt-6 pt-4 border-t border-purple-900/50">
                        <button class="like-button action-button-icon ${likeButtonClasses}">
                            <hero-icon-outline name="heart"></hero-icon-outline>
                            <span class="font-bold">${likeCount}</span>
                        </button>
                        <button class="comment-button secondary-button">
                            <hero-icon-outline name="chat-bubble-left"></hero-icon-outline>
                            <span>Comment</span>
                            <span class="font-bold ml-1">${post.commentCount || 0}</span>
                        </button>
                    </footer>
                    <div class="comments-section hidden mt-6 pt-4 border-t border-purple-900/50">
                        <div class="comments-list space-y-4"></div>
                        <form class="comment-form flex gap-2 mt-4">
                            <input type="text" placeholder="Add a comment..." class="input-field !text-sm w-full" required>
                            <button type="submit" class="neon-button !text-sm !py-2 !px-4">Post</button>
                        </form>
                    </div>
                `;
                container.appendChild(postElement);
            });
        }
        
        timelineContainer.addEventListener('click', async (e) => {
            const likeButton = e.target.closest('.like-button');
            const deleteButton = e.target.closest('.delete-post-button');
            const commentButton = e.target.closest('.comment-button');
            const postElement = e.target.closest('.card');
            if (!postElement) return;

            const postId = postElement.dataset.id;
            const user = auth.currentUser;

            if (likeButton) {
                if (!user) return;
                const postRef = doc(db, "posts", postId);
                const postSnap = await getDoc(postRef);
                if (postSnap.exists()) {
                    const postData = postSnap.data();
                    const likes = postData.likes || {};
                    likes[user.uid] ? delete likes[user.uid] : likes[user.uid] = true;
                    await updateDoc(postRef, { likes });
                }
            }
            if (deleteButton) {
                if (confirm("Are you sure you want to delete this post?")) {
                    try { await deleteDoc(doc(db, "posts", postId)); } 
                    catch (error) { console.error("Error deleting post: ", error); alert("Could not delete post."); }
                }
            }
            if (commentButton) {
                const commentsSection = postElement.querySelector('.comments-section');
                const isHidden = commentsSection.classList.toggle('hidden');
                if (!isHidden) {
                    loadComments(postId, postElement.querySelector('.comments-list'));
                }
            }
        });
        
        timelineContainer.addEventListener('submit', async (e) => {
            if (!e.target.classList.contains('comment-form')) return;
            e.preventDefault();
            const postElement = e.target.closest('.card');
            const postId = postElement.dataset.id;
            const user = auth.currentUser;
            const input = e.target.querySelector('input');
            const content = input.value.trim();
            if (!content || !user) return;

            try {
                await addDoc(collection(db, "posts", postId, "comments"), {
                    authorId: user.uid,
                    authorDisplayName: user.displayName,
                    content: content,
                    createdAt: serverTimestamp()
                });
                await updateDoc(doc(db, "posts", postId), { commentCount: increment(1) });
                input.value = '';
            } catch (error) { console.error("Error adding comment:", error); }
        });

        function loadComments(postId, container) {
            const commentsQuery = query(collection(db, "posts", postId, "comments"), orderBy("createdAt", "asc"));
            onSnapshot(commentsQuery, (snapshot) => {
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = `<p class="text-sm text-gray-500">No comments yet.</p>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    const date = comment.createdAt ? new Date(comment.createdAt.toDate()).toLocaleTimeString() : '';
                    const commentEl = document.createElement('div');
                    commentEl.className = 'flex items-start gap-3';
                    const author = comment.authorDisplayName || comment.authorId;
                    commentEl.innerHTML = `
                        <hero-icon-outline name="user-circle" class="text-main-purple text-3xl"></hero-icon-outline>
                        <div class="bg-gray-900/50 p-3 rounded-lg flex-grow">
                            <div class="flex items-baseline gap-2">
                                <span class="font-bold text-sm">${author}</span>
                                <span class="text-xs text-gray-500">${date}</span>
                            </div>
                            <p class="text-gray-300">${comment.content}</p>
                        </div>
                    `;
                    container.appendChild(commentEl);
                });
            });
        }
    </script>
    <script src="src/js/particle-animation.js"></script>
</body>
</html>